<% content_for :title, "Articles" %>

<div id="articles">

  <div class="row justify-content-center mx-0 px-0">
    <div class="col-12 col-sm-6 mb-4">

      <% if notice %>
        <p class="my-3">
          <span class="d-block notice" style="color: red"> <strong> <%= notice %> </strong> </span>
        </p>
      <% end %>

      <% if @comment && @comment.errors.any? %>
        <div id="error_explanation" class="mx-2"  style="color: red">
          <h2><%= pluralize(@comment.errors.count, "Error: ") %> No es posible crear artículo</h2>
          <ul>
            <% @comment.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <nav aria-label="Page navigation">
        <ul class="pagination pagination-lg justify-content-center">
          <%== pagy_bootstrap_nav(@pagy) %>
        </ul>
      </nav>

      <% @articles.each do |article| %>

        <%= render article %>

        <% if (comment = article.comments.last) %>  <!-- Asigno el último comentario y verifico si existe -->
          
          <h6 class="mt-4"> <strong>Último comentario. </strong>Realizado el <%= comment.created_at.strftime("%d-%m-%Y %H:%M") %> </h6>

          <div class="d-flex align-items-start my-2 border border-2 border-secondary-subtle rounded">
    
            <% if user_signed_in? %>
              <div class="ms-2"> 
                <% if current_user.photo.attached? %>
                    <%= image_tag current_user.photo, class: "img-fluid rounded-circle", style: "max-width: 50px; max-height: 50px; width: 100%; height: auto;" %>
                <% end %>
              </div>
            <% end %>

            <div class="flex-grow-1 ms-2"> 
              <% if comment.user %>
                 <strong>Usuario   </strong> : <%= comment.user.name %>
              <% else %>
                  <strong> Comentario Anónimo </strong>
              <% end %>
              <br>
              <%= comment.content %>
            </div>

          </div>
     
        <% end %>

        <% if article.comments.count > 1%>
          <%= link_to "Ver todos los comentarios ".html_safe + "<span class='top-0 badge rounded-pill bg-danger'> + #{article.comments.count - 1} </span>".html_safe, article, class: "btn btn-success mt-2" %>
        <% end %>

        <%= render "comments/form", comment: @comment, article: article %>

      <% end %>
      <br>
    </div>
  </div>

</div>

